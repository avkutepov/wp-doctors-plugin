# Doctors CPT Plugin

Плагин для создания каталога врачей с возможностью фильтрации по специализации и городу.

---

## Установка и использование

### Требования

- WordPress 5.0+
- PHP 7.4+
- Тема `doctors-theme` (входит в комплект)

### Установка

1. Установите и активируйте плагин `doctors-plugin`
2. Установите и активируйте тему `doctors-theme`

**Что происходит при активации:**

**Плагин:**
- Автоматически копирует файлы переводов в `/wp-content/languages/plugins/`
- Создает директорию `/wp-content/languages/plugins/` если её нет
- Обновляет правила постоянных ссылок (rewrite rules) для работы страниц `/doctors/`
- После активации страницы архива и карточки врачей работают сразу, без необходимости пересохранения настроек постоянных ссылок

**Тема:**
- Автоматически копирует файлы переводов в `/wp-content/languages/themes/`
- Создает директорию `/wp-content/languages/themes/` если её нет

### Первоначальная настройка

1. **Создайте таксономии:**
   - Перейдите в раздел "Специализации" и добавьте специализации врачей (например: Терапевт, Хирург, Кардиолог)
   - Перейдите в раздел "Города" и добавьте города (например: Москва, Краснодар)

2. **Добавьте врачей:**
   - Перейдите в раздел "Врачи" → "Добавить нового"
   - Заполните обязательные поля:
     - Название (ФИО врача)
     - Описание
     - Изображение (фото врача)
   - Заполните мета-поля:
     - **Опыт работы** (в годах, число)
     - **Цена приема** (число)
     - **Рейтинг** (от 0 до 5)
   - Назначьте таксономии:
     - Выберите одну или несколько специализаций
     - Выберите город
   - Опубликуйте запись

3. **Просмотр каталога:**
   - Перейдите по адресу `/doctors/` для просмотра всех врачей
   - Используйте фильтры для поиска по специализации и городу
   - Используйте сортировку по рейтингу, цене или опыту

### Страницы

- **Архив врачей:** `/doctors/` - список всех врачей с фильтрами и сортировкой
- **Карточка врача:** `/doctors/{slug}/` - детальная информация о враче

### Фильтрация

На странице архива доступны следующие фильтры:

- **По специализации** - выбор из списка специализаций
- **По городу** - выбор из списка городов
- **Сортировка:**
  - По рейтингу (от высокого к низкому)
  - По цене (от низкой к высокой)
  - По опыту (от большего к меньшему)

### Обновление переводов

Переводы хранятся в папках:
- Плагин: `/wp-content/plugins/doctors-plugin/languages/`
- Тема: `/wp-content/themes/doctors-theme/languages/`

При активации плагина/темы переводы копируются в:
- `/wp-content/languages/plugins/`
- `/wp-content/languages/themes/`

Для обновления переводов:

1. Отредактируйте файл `.po` в исходной папке плагина/темы
2. Скомпилируйте новый `.mo` файл командой:
   ```bash
   msgfmt doctors-plugin-ru_RU.po -o doctors-plugin-ru_RU.mo
   ```
3. Деактивируйте и заново активируйте плагин/тему для копирования обновленных файлов

---

## Архитектура

### Структура плагина

```
doctors-plugin/
├── inc/
│   ├── class-cpt-doctor.php           # Регистрация типа записи "Врачи"
│   ├── class-taxonomy-doctor.php      # Универсальный класс для таксономий
│   ├── class-meta-doctor.php          # Регистрация мета-полей
│   └── class-archive-query-doctor.php # Модификация запроса архива (сортировка)
├── languages/
│   ├── doctors-plugin-ru_RU.po
│   └── doctors-plugin-ru_RU.mo
└── doctors-plugin.php                 # Главный файл плагина
```

### Принципы разработки

**Один класс - одна задача:**
- Каждый класс в папке `inc/` отвечает за одну конкретную задачу
- Упрощает поддержку и масштабирование кода

**Объектно-ориентированный подход:**
- Используется ООП для возможности повторного использования и расширения функционала
- Пример: класс `Doctors_Taxonomy` используется для создания любых таксономий

**Безопасность:**
- Все GET-параметры санитизируются через `sanitize_text_field()`
- Проверка прав доступа `current_user_can('edit_post')` при сохранении мета-данных
- Использование `esc_html()`, `esc_attr()`, `esc_url()` для защиты от XSS
- Проверка `is_wp_error()` при работе с таксономиями

### Таксономии

#### Класс: `Doctors_Taxonomy`

Универсальный класс для создания таксономий. Позволяет легко добавлять новые таксономии без дублирования кода.

**Использование:**

```php
// Создание иерархической таксономии (как категории)
new Doctors_Taxonomy('specialization', true);

// Создание неиерархической таксономии (как метки)
new Doctors_Taxonomy('city', false);
```

**Параметры конструктора:**
- `$taxonomy_name` (string) - название таксономии
- `$hierarchical` (bool) - иерархическая или нет (по умолчанию: `false`)

#### Таксономия "Город"

Город по умолчанию **не иерархическая**, так как обычно врач работает в одном городе.

**Исключения:**
Если врачи работают в нескольких местах (например, в поселке и областном центре), то можно включить иерархию, изменив параметр в `doctors-plugin.php`:

```php
// Было:
new Doctors_Taxonomy('city', false);

// Стало:
new Doctors_Taxonomy('city', true);
```

### Фильтрация и сортировка

**Фильтрация:**
- Обрабатывается стандартными механизмами WordPress
- При передаче параметров `specialization` и `city` с slug-значениями, WordPress автоматически применяет фильтрацию
- Кастомный код для фильтрации **не требуется**

**Сортировка:**
- Реализована в классе `Doctors_Archive_Query`
- Обрабатывает параметр `sort` из URL
- Доступна сортировка по мета-полям: рейтинг, цена, опыт

### Хуки активации и деактивации

**При активации плагина (`register_activation_hook`):**
1. Вызывается функция `doctors_plugin_activation()`
2. Копируются файлы переводов в централизованную директорию
3. Временно регистрируется CPT "doctors" для обновления правил маршрутизации
4. Вызывается `flush_rewrite_rules()` - обновляет .htaccess и правила URL
5. После этого страницы `/doctors/` и `/doctors/{slug}/` работают сразу

**При деактивации плагина (`register_deactivation_hook`):**
1. Вызывается функция `doctors_plugin_deactivation()`
2. Вызывается `flush_rewrite_rules()` - очищает правила для удаленного CPT

### Интернационализация (i18n)

**В плагине:**
- Text Domain: `doctors-plugin`
- Путь к переводам: `languages/`
- Автокопирование при активации в `/wp-content/languages/plugins/`
- Директория создается автоматически через `wp_mkdir_p()` если отсутствует

**В теме:**
- Text Domain: `doctors-theme`
- Путь к переводам: `languages/`
- Автокопирование при активации в `/wp-content/languages/themes/`
- Директория создается автоматически через `wp_mkdir_p()` если отсутствует

Использование переводов в коде:

```php
esc_html_e( 'All specializations', 'doctors-theme' );
esc_html__( 'Experience:', 'doctors-plugin' );
```

### Тема

Тема создана с нуля для демонстрации чистого решения задачи. Включает только необходимые шаблоны:

- `archive-doctors.php` - шаблон архива врачей с фильтрами
- `single-doctors.php` - шаблон карточки врача
- `functions.php` - базовые настройки темы

### Возможности масштабирования

1. **Добавление новых таксономий:**
   ```php
   new Doctors_Taxonomy('education', false); // Образование
   new Doctors_Taxonomy('awards', false);    // Награды
   ```

2. **Добавление новых мета-полей:**
   Можно переработать класс `Doctors_Meta_Doctor` по аналогии с `Doctors_Taxonomy` для универсального создания мета-полей

3. **Расширение сортировки:**
   Добавить новые варианты в метод `apply_sorting()` класса `Doctors_Archive_Query`


---

## Автор

**Андрей Кутепов**

- Telegram: [@kutepov_web](https://t.me/kutepov_web)
- Кейсы / примеры работ: [netork.ru](https://netork.ru/)

При возникновении вопросов обращайтесь к автору плагина.
